# Wnioski (SPA 1042)

> **–û–±—ä–µ–∫—Ç: –ó–∞—è–≤–ª–µ–Ω–∏—è**
>
> –í–µ—Ä—Å–∏—è: 1.1 | –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2026-01-04

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞

**Wnioski** - –æ–±—ä–µ–∫—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–ª–µ–Ω–∏—è–º–∏ –Ω–∞ –≤–∏–∑—ã, –∫–∞—Ä—Ç—ã –ø–æ–±—ã—Ç—É –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —Ä–∞–±–æ—Ç—É.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–ª–µ–Ω–∏–π
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ –∑–∞—è–≤–ª–µ–Ω–∏–π (–≤–∏–∑–∞, –∫–∞—Ä—Ç–∞ –ø–æ–±—ã—Ç—É, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É)
- –≠—Ç–∞–ø—ã –ø–æ–¥–∞—á–∏ –∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è
- –•—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤
- –°–≤—è–∑—å —Å –¥–µ–ª–æ–º –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–∞ (Sprawy cudzoziemc√≥w)

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|--------------|----------|
| `ID` | Integer | –î–∞ | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞—è–≤–ª–µ–Ω–∏—è |
| `TITLE` | String | –î–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞—è–≤–ª–µ–Ω–∏—è |
| `STAGE_ID` | String | –î–∞ | –°—Ç–∞–¥–∏—è –∑–∞—è–≤–ª–µ–Ω–∏—è |
| `CONTACT_ID` | Integer | –î–∞ | –°–≤—è–∑—å —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º (–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º) |
| `CREATED_TIME` | DateTime | –î–∞ | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `UPDATED_TIME` | DateTime | –î–∞ | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è (UF_CRM_*)

> ‚ö†Ô∏è **TODO:** –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–ª–µ–π —á–µ—Ä–µ–∑ Bitrix24 REST API:
> ```bash
> curl "https://bergermann.bitrix24.pl/rest/crm.type.fields?entityTypeId=1042&auth=..."
> ```

**–¢–∏–ø–∏—á–Ω—ã–µ –ø–æ–ª—è:**
- –¢–∏–ø –∑–∞—è–≤–ª–µ–Ω–∏—è (–≤–∏–∑–∞, –∫–∞—Ä—Ç–∞ –ø–æ–±—ã—Ç—É, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É)
- –î–∞—Ç–∞ –ø–æ–¥–∞—á–∏
- –ù–æ–º–µ—Ä –∑–∞—è–≤–ª–µ–Ω–∏—è
- –°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è
- –†–µ–∑—É–ª—å—Ç–∞—Ç (–æ–¥–æ–±—Ä–µ–Ω–æ/–æ—Ç–∫–∞–∑–∞–Ω–æ)
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

---

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–æ—Ä–º—ã

> ‚ö†Ô∏è **TODO:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ API

---

## ‚öôÔ∏è –°–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞

### –°–≤—è–∑–∏ (Relations)

```mermaid
graph TB
    Contact["Contact<br/>(–ö–æ–Ω—Ç–∞–∫—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞)"]
    Sprawy["Sprawy cudzoziemc√≥w<br/>(SPA 1038)<br/>üéØ –î–µ–ª–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–µ–≤"]
    Wnioski["Wnioski<br/>(SPA 1042)<br/>üìù –ó–∞—è–≤–ª–µ–Ω–∏—è"]

    Contact -->|"contactId"| Wnioski
    Contact -->|"contactId"| Sprawy
    Sprawy -.->|"Wnioski field<br/>(–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–≤—è–∑—å)"| Wnioski

    style Sprawy fill:#9cf,stroke:#36f,stroke-width:3px
    style Contact fill:#fc9,stroke:#f60,stroke-width:2px
    style Wnioski fill:#f9c,stroke:#c36,stroke-width:3px
```

**–ö–ª—é—á–µ–≤—ã–µ —Å–≤—è–∑–∏:**
- `Contact` ‚Üí `Wnioski` (—á–µ—Ä–µ–∑ `contactId`) - –æ–¥–∏–Ω –∫–æ–Ω—Ç–∞–∫—Ç –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞—è–≤–ª–µ–Ω–∏–π
- `Sprawy cudzoziemc√≥w` ‚Üí `Wnioski` (—á–µ—Ä–µ–∑ –ø–æ–ª–µ —Å–≤—è–∑–∏) - –≤ –¥–µ–ª–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞

### –°—Ç–∞–¥–∏–∏ (Stages)

> ‚ö†Ô∏è **TODO:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–¥–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è (–ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ API)

**–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–µ —Å—Ç–∞–¥–∏–∏:**
- `NEW` - –ù–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ
- `IN_PREPARATION` - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- `SUBMITTED` - –ü–æ–¥–∞–Ω–æ
- `IN_REVIEW` - –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
- `APPROVED` - –û–¥–æ–±—Ä–µ–Ω–æ (SUCCESS)
- `REJECTED` - –û—Ç–∫–∞–∑–∞–Ω–æ (FAIL)
- `CANCELLED` - –û—Ç–º–µ–Ω–µ–Ω–æ

**–ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–¥–∏–∏** (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å Cudzoziemcy):
- NEW, IN_PREPARATION, SUBMITTED, IN_REVIEW

**–§–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∞–¥–∏–∏** (–ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è):
- APPROVED, REJECTED, CANCELLED, SUCCESS, FAIL, FAILURE, COMPLETED

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å—ã

### 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Sprawy cudzoziemc√≥w

**–¢—Ä–∏–≥–≥–µ—Ä:** –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ Wnioski

```mermaid
sequenceDiagram
    participant W as Wnioski (1042)
    participant B24 as Bitrix24
    participant HTTP as b24-spa-1038-http
    participant PS as Pub/Sub
    participant Worker as b24-spa-1038-sync-worker
    participant S as Sprawy (1038)

    W->>B24: Create/Update Wnioski
    B24->>HTTP: Webhook: ONCRMDYNAMICITEM*[1042]
    activate HTTP
    HTTP->>PS: Publish message
    HTTP-->>B24: 200 OK
    deactivate HTTP

    PS->>Worker: Trigger Worker
    activate Worker

    Worker->>B24: Get Wnioski details
    B24-->>Worker: Wnioski data (contactId, stageId)

    Worker->>Worker: Check if ACTIVE<br/>(stageId not in SUCCESS/FAIL)

    alt Wnioski is ACTIVE
        Worker->>B24: Get all active Wnioski for Contact
        B24-->>Worker: List of active Wnioski

        Worker->>B24: Find Sprawy for Contact
        B24-->>Worker: List of Sprawy

        loop For each Sprawy
            Worker->>S: Update Wnioski field<br/>(add link)
            S-->>Worker: Updated
        end
    else Wnioski is INACTIVE (final stage)
        Worker->>B24: Find Sprawy for Contact
        B24-->>Worker: List of Sprawy

        loop For each Sprawy
            Worker->>S: Update Wnioski field<br/>(remove link)
            S-->>Worker: Updated
        end
    end

    Worker->>B24: Post to Timeline
    deactivate Worker
```

**–õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ Wnioski –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –µ–≥–æ —Å—Ç–∞—Ç—É—Å (stageId)
2. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å **–∞–∫—Ç–∏–≤–Ω—ã–π** (–Ω–µ SUCCESS/FAIL/COMPLETED):
   - –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ "Wnioski" –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö Sprawy cudzoziemc√≥w
3. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å **—Ñ–∏–Ω–∞–ª—å–Ω—ã–π** (SUCCESS/FAIL/COMPLETED):
   - –£–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ø–æ–ª—è "Wnioski" –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö Sprawy cudzoziemc√≥w
4. –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Wnioski - —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö Sprawy

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**
- `b24-spa-1038-sync` (HTTP + Worker)
- –°–µ—Ä–≤–∏—Å: `wnioski_sync.py`

### 2. –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** 03:00 UTC (Cloud Scheduler)

–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö Wnioski –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞.

---

## üîß –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

#### 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–ª–µ–Ω–∏–π

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–ª–µ–Ω–∏–π –≤ Sprawy cudzoziemc√≥w
- –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–ª–µ–Ω–∏—è (–∏—Å–∫–ª—é—á–∞—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ)

**–¢—Ä–∏–≥–≥–µ—Ä:**
- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Wnioski
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ Wnioski
- –£–¥–∞–ª–µ–Ω–∏–µ Wnioski
- –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (03:00)

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
- ‚úÖ –í–∫–ª—é—á–∞—é—Ç—Å—è: NEW, IN_PREPARATION, SUBMITTED, IN_REVIEW
- ‚ùå –ò—Å–∫–ª—é—á–∞—é—Ç—Å—è: SUCCESS, FAIL, FAILURE, COMPLETED, REJECTED, CANCELLED

### REST API –º–µ—Ç–æ–¥—ã

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–ª–µ–Ω–∏—è

```bash
curl -X POST "https://bergermann.bitrix24.pl/rest/crm.item.get" \
  -d "entityTypeId=1042" \
  -d "id=4" \
  -d "auth=[ACCESS_TOKEN]"
```

#### –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–ª–µ–Ω–∏—è

```bash
curl -X POST "https://bergermann.bitrix24.pl/rest/crm.item.add" \
  -d "entityTypeId=1042" \
  -d "fields[contactId]=208" \
  -d "fields[title]=Wniosek o kartƒô pobytu" \
  -d "auth=[ACCESS_TOKEN]"
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–ª–µ–Ω–∏—è

```bash
curl -X POST "https://bergermann.bitrix24.pl/rest/crm.item.update" \
  -d "entityTypeId=1042" \
  -d "id=4" \
  -d "fields[stageId]=DT1042_40:SUBMITTED" \
  -d "auth=[ACCESS_TOKEN]"
```

#### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–ª–µ–Ω–∏–π

```bash
curl -X POST "https://bergermann.bitrix24.pl/rest/crm.item.list" \
  -d "entityTypeId=1042" \
  -d "filter[contactId]=208" \
  -d "order[id]=DESC" \
  -d "auth=[ACCESS_TOKEN]"
```

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [Legalizacja Module Overview](../legalizacja-module.md) - –û–±–∑–æ—Ä –º–æ–¥—É–ª—è
- [Sprawy cudzoziemc√≥w (SPA 1038)](./sprawy-cudzoziemcow.md) - –î–µ–ª–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–µ–≤
- [–û–±—ä–µ–∫—Ç—ã –º–æ–¥—É–ª—è](./README.md) - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- [b24-spa-1038-sync Service](../../../google-cloud/b24-spa-1038-sync/README.md) - –°–µ—Ä–≤–∏—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

## üìÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2026-01-04 (v1.1)
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Sprawy cudzoziemc√≥w (SPA 1038)
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å `wnioski_sync.py`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π SPA 1042 –≤ worker
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–ª–µ–Ω–∏–π
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 2026-01-04 (v1.0)
- ‚úÖ –°–æ–∑–¥–∞–Ω –±–∞–∑–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–±—ä–µ–∫—Ç–∞ Wnioski

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

**–ü–æ–ª–µ —Å–≤—è–∑–∏:**
- –ö–æ–¥ –ø–æ–ª—è –≤ Sprawy cudzoziemc√≥w: `ufCrm8_1767556733`
- –ù–∞–∑–≤–∞–Ω–∏–µ: "Wnioski"
- –¢–∏–ø: CRM (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–≤—è–∑—å)
- –°–≤—è–∑—å —Å: DYNAMIC_1042 (Wnioski)

**–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è:**
```json
"ufCrm8_1767556733": ["4", "5", "6"]  // IDs –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–ª–µ–Ω–∏–π
```

---

**–ê–≤—Ç–æ—Ä:** KeyFrame Lab
**–í–µ—Ä—Å–∏—è:** 1.1
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-04
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2026-01-04

