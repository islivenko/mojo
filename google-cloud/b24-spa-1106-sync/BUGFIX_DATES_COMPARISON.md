# Bugfix: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞—Ç —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—è "Data wa≈ºno≈õci podstawy pobytu" –≤ Sprawy –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞:

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. Contact 194 –∏–º–µ–µ—Ç 3 Podstawy pobytu
2. –í—Å–µ 3 –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –¥–∞—Ç—É "Data do kiedy" = `2027-06-30`
3. –û–¥–Ω–∞ –∏–∑ Podstawy (#52) –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å (SUCCESS)
4. Worker –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –¥–∞—Ç—É –∏–∑ Sprawy
5. **–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞—Ç–∞ –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- Sprawy –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å **2 –¥–∞—Ç—ã** (–æ—Ç 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö Podstawy)

**–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- Sprawy —Å–æ–¥–µ—Ä–∂–∏—Ç **3 –¥–∞—Ç—ã** (—Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å)

---

## üîç –ü—Ä–∏—á–∏–Ω–∞

–í —Ñ–∞–π–ª–µ `pobyt_sync.py`, –º–µ—Ç–æ–¥ `sync_all_for_contact()`, —Å—Ç—Ä–æ–∫–∞ 412:

```python
dates_in_sync = set(current_dates) == set(new_dates)
```

**–ü—Ä–æ–±–ª–µ–º–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `set()`:**

–ú–Ω–æ–∂–µ—Å—Ç–≤–æ (`set`) —É–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã, –ø–æ—ç—Ç–æ–º—É:
- `['2027-06-30', '2027-06-30', '2027-06-30']` ‚Üí `set()` = `{'2027-06-30'}` (1 —ç–ª–µ–º–µ–Ω—Ç)
- `['2027-06-30', '2027-06-30']` ‚Üí `set()` = `{'2027-06-30'}` (1 —ç–ª–µ–º–µ–Ω—Ç)

–ú–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ä–∞–≤–Ω—ã (`{'2027-06-30'}` == `{'2027-06-30'}`), —Ö–æ—Ç—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ä–∞–∑–Ω–æ–µ!

–°–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–ª–∞, —á—Ç–æ –¥–∞—Ç—ã —É–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ó–∞–º–µ–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤ –Ω–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ **–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤**:

### –î–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```python
# Check if both links and dates are in sync
links_in_sync = set(current_links) == set(new_links)
dates_in_sync = set(current_dates) == set(new_dates)
```

### –ü–æ—Å–ª–µ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```python
# Check if both links and dates are in sync
# For links, use set comparison (order doesn't matter, duplicates shouldn't exist)
links_in_sync = set(current_links) == set(new_links)
# For dates, use sorted list comparison (duplicates matter, order doesn't)
dates_in_sync = sorted(current_dates) == sorted(new_dates)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
- `sorted(['2027-06-30', '2027-06-30', '2027-06-30'])` = `['2027-06-30', '2027-06-30', '2027-06-30']`
- `sorted(['2027-06-30', '2027-06-30'])` = `['2027-06-30', '2027-06-30']`
- –°–ø–∏—Å–∫–∏ –ù–ï —Ä–∞–≤–Ω—ã ‚Üí —Å–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
current_dates = ['2027-06-30', '2027-06-30', '2027-06-30']
new_dates = ['2027-06-30', '2027-06-30']

# –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
dates_in_sync = set(current_dates) == set(new_dates)
print(dates_in_sync)  # True ‚ùå (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
```

### –¢–µ—Å—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
current_dates = ['2027-06-30', '2027-06-30', '2027-06-30']
new_dates = ['2027-06-30', '2027-06-30']

# –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
dates_in_sync = sorted(current_dates) == sorted(new_dates)
print(dates_in_sync)  # False ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Sprawy ID=18:
  Links: ['48', '54'] (2 –∞–∫—Ç–∏–≤–Ω—ã—Ö)
  Dates: ['2027-06-30', '2027-06-30', '2027-06-30'] (3 –¥–∞—Ç—ã) ‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Sprawy ID=18:
  Links: ['48', '54'] (2 –∞–∫—Ç–∏–≤–Ω—ã—Ö)
  Dates: ['2027-06-30', '2027-06-30'] (2 –¥–∞—Ç—ã) ‚úÖ
```

### –õ–æ–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
```
Sprawy 18:
  Action: synced
  Previous links: ['48', '54']
  New links: ['48', '54']
  Previous dates: ['2027-06-30', '2027-06-30', '2027-06-30']
  New dates: ['2027-06-30', '2027-06-30']
  Links updated: False
  Dates updated: True ‚úÖ
```

---

## üöÄ Deployment

**Worker Function:** `b24-spa-1106-sync-worker`  
**Revision:** `00007-kig`  
**Deployed:** 2026-01-18 14:34:28 UTC  
**Status:** ‚úÖ Active

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –§–∞–π–ª: `services/pobyt_sync.py`
- –°—Ç—Ä–æ–∫–∞: 412
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ: `set(current_dates) == set(new_dates)` ‚Üí `sorted(current_dates) == sorted(new_dates)`

---

## üéØ –í–ª–∏—è–Ω–∏–µ

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ Podstawy —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –¥–∞—Ç–∞–º–∏**
   - –î–æ: –î–∞—Ç—ã –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
   - –ü–æ—Å–ª–µ: –î–∞—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚úÖ

2. **Podstawy –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å**
   - –î–æ: –î–∞—Ç–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –≤ Sprawy
   - –ü–æ—Å–ª–µ: –î–∞—Ç–∞ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Sprawy ‚úÖ

3. **–£–¥–∞–ª–µ–Ω–∏–µ Podstawy**
   - –î–æ: –î–∞—Ç–∞ –º–æ–≥–ª–∞ –æ—Å—Ç–∞—Ç—å—Å—è –≤ Sprawy
   - –ü–æ—Å–ª–µ: –î–∞—Ç–∞ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Sprawy ‚úÖ

### –ù–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `set()` - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è ID)
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞—Ç (—Ä–∞–±–æ—Ç–∞–ª–æ –∏ –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- –î—Ä—É–≥–∏–µ —Ç–∏–ø—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Praca, Procesy, Contact)

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç–æ–∫:

1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤, –∞ –Ω–µ –º–Ω–æ–∂–µ—Å—Ç–≤
   - –£—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ –ø–æ—Ä—è–¥–æ–∫ –º–æ–∂–µ—Ç –Ω–µ –∏–º–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è ‚Üí `sorted()`

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å edge cases (–≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ)

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—É—â–∏–µ, —Ç–∞–∫ –∏ —Ü–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É, –ø–æ—á–µ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
cd /Users/Dev/mojo_agency
python3 -c "
import sys
sys.path.insert(0, 'google-cloud/b24-spa-1106-sync/b24-spa-1106-sync-worker')
from services.bitrix_api import BitrixAPI

bitrix = BitrixAPI(
    domain='mojo.bitrix24.pl',
    project_id='mojo-478621',
    access_token_secret='b24-access-token'
)

sprawy = bitrix.get_item(1106, 18)
links = sprawy.get('ufCrm38_1768737959', [])
dates = sprawy.get('ufCrm38_1768738011252', [])

print(f'Links: {len(links)}')
print(f'Dates: {len(dates)}')
print(f'Match: {len(links) == len(dates)}')
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Links: 2
Dates: 2
Match: True
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [PODSTAWY_DATES_SYNC.md](./PODSTAWY_DATES_SYNC.md) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞—Ç
- [pobyt_sync.py](./b24-spa-1106-sync-worker/services/pobyt_sync.py) - –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å–µ—Ä–≤–∏—Å–∞
- [SYNC_CONFIGURATION.md](./SYNC_CONFIGURATION.md) - –û–±—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
