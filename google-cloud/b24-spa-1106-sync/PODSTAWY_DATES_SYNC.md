# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è "Data wa≈ºno≈õci podstawy pobytu"

## ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞—Ç –∏–∑ Podstawy pobytu –≤ Sprawy

### üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–ª–µ **"Data wa≈ºno≈õci podstawy pobytu"** –≤ Sprawy (SPA 1106) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∞—Ç–∞–º–∏ –∏–∑ –ø–æ–ª—è **"Data do kiedy"** –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö **–∞–∫—Ç–∏–≤–Ω—ã—Ö** Podstawy pobytu (SPA 1042).

---

## üîó –ü–æ–ª—è

### Podstawy pobytu (SPA 1042)
- **–ü–æ–ª–µ:** `ufCrm10_1763581700754`
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** "Data do kiedy"
- **–¢–∏–ø:** date (–æ–¥–∏–Ω–æ—á–Ω–æ–µ –ø–æ–ª–µ)

### Sprawy (SPA 1106)
- **–ü–æ–ª–µ:** `ufCrm38_1768738011252`
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** "Data wa≈ºno≈õci podstawy pobytu"
- **–¢–∏–ø:** date (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–ª–µ)

### –°–≤—è–∑—å Podstawy ‚Üí Sprawy
- **–ü–æ–ª–µ:** `ufCrm38_1768737959`
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** "Aktualne Podstawy pobytu"
- **–¢–∏–ø:** crm (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–ª–µ, —Å—Å—ã–ª–∫–∏ –Ω–∞ SPA 1042)

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 1. –°–±–æ—Ä –¥–∞—Ç
–î–ª—è –∫–∞–∂–¥–æ–≥–æ **–∞–∫—Ç–∏–≤–Ω–æ–≥–æ** Podstawy pobytu, —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º:
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è `ufCrm10_1763581700754` (Data do kiedy)
- –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ** Podstawy pobytu:
- **–ê–∫—Ç–∏–≤–Ω—ã–µ:** —Å—Ç–∞–¥–∏—è –ù–ï –≤ `{SUCCESS, FAIL, FAILURE, LOSE, APOLOGY}`
- **–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ:** –¥–∞—Ç—ã –∏–∑ –Ω–∏—Ö –ù–ï –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ Sprawy

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Sprawy
–ü–æ–ª–µ `ufCrm38_1768738011252` –≤ Sprawy **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç—Å—è** —Å–ø–∏—Å–∫–æ–º –¥–∞—Ç –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö Podstawy:
- –°—Ç–∞—Ä—ã–µ –¥–∞—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è
- –ù–æ–≤—ã–µ –¥–∞—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è
- –ü–æ—Ä—è–¥–æ–∫: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é

### 4. –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π —Å—Å—ã–ª–æ–∫:
- –ü—Ä–∏ –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (full_sync) ‚Üí –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏ —Å—Å—ã–ª–∫–∏, –∏ –¥–∞—Ç—ã
- –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ –æ—Ç Podstawy ‚Üí **–≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
  - –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –≤ –æ–¥–Ω–æ–º Podstawy, –≤—Å–µ –¥–∞—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ `sync_all_for_contact()` –≤–º–µ—Å—Ç–æ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

## üìä –ü—Ä–∏–º–µ—Ä

### –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**Contact 194** –∏–º–µ–µ—Ç 3 Podstawy pobytu:

| ID | –ù–∞–∑–≤–∞–Ω–∏–µ | –°—Ç–∞–¥–∏—è | Data do kiedy | –°—Ç–∞—Ç—É—Å |
|----|----------|--------|---------------|--------|
| 48 | KARTA POBYTU MOJO | NEW | 2027-06-30 | ‚úÖ ACTIVE |
| 52 | Podstawy pobytu #52 | NEW | 2027-06-30 | ‚úÖ ACTIVE |
| 54 | Podstawy pobytu #54 | NEW | 2027-06-30 | ‚úÖ ACTIVE |

### –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ Sprawy 18

**–ü–æ–ª–µ `ufCrm38_1768737959` (Aktualne Podstawy pobytu):**
```json
["48", "52", "54"]
```

**–ü–æ–ª–µ `ufCrm38_1768738011252` (Data wa≈ºno≈õci podstawy pobytu):**
```json
[
  "2027-06-30T03:00:00+03:00",
  "2027-06-30T03:00:00+03:00",
  "2027-06-30T03:00:00+03:00"
]
```

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

```
Contact 194
  ‚îú‚îÄ‚îÄ Podstawy pobytu #48 (ACTIVE)
  ‚îÇ   ‚îî‚îÄ‚îÄ Data do kiedy: 2027-06-30 ‚úÖ
  ‚îú‚îÄ‚îÄ Podstawy pobytu #52 (ACTIVE)
  ‚îÇ   ‚îî‚îÄ‚îÄ Data do kiedy: 2027-06-30 ‚úÖ
  ‚îî‚îÄ‚îÄ Podstawy pobytu #54 (ACTIVE)
      ‚îî‚îÄ‚îÄ Data do kiedy: 2027-06-30 ‚úÖ

      ‚Üì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Üì

Sprawy #18
  ‚îú‚îÄ‚îÄ Aktualne Podstawy pobytu: [48, 52, 54]
  ‚îî‚îÄ‚îÄ Data wa≈ºno≈õci podstawy pobytu: 
      ‚îú‚îÄ‚îÄ 2027-06-30
      ‚îú‚îÄ‚îÄ 2027-06-30
      ‚îî‚îÄ‚îÄ 2027-06-30
```

---

## üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ Podstawy pobytu
1. –°–æ–∑–¥–∞–µ—Ç—Å—è Podstawy pobytu ID=60 –¥–ª—è Contact 194
2. –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è "Data do kiedy" = 2028-12-31
3. Webhook ‚Üí Worker ‚Üí –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
4. Sprawy 18:
   - –°—Å—ã–ª–∫–∏: `["48", "52", "54", "60"]`
   - –î–∞—Ç—ã: `["2027-06-30", "2027-06-30", "2027-06-30", "2028-12-31"]`

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –≤ Podstawy
1. –í Podstawy ID=48 –∏–∑–º–µ–Ω—è–µ—Ç—Å—è "Data do kiedy" —Å 2027-06-30 –Ω–∞ 2029-01-15
2. Webhook ‚Üí Worker ‚Üí –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
3. Sprawy 18:
   - –î–∞—Ç—ã: `["2027-06-30", "2027-06-30", "2029-01-15"]`

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Podstawy –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞–¥–∏—é
1. Podstawy ID=52 –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å—Ç–∞–¥–∏—é SUCCESS
2. Webhook ‚Üí Worker ‚Üí –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
3. Sprawy 18:
   - –°—Å—ã–ª–∫–∏: `["48", "54"]` (52 —É–¥–∞–ª–µ–Ω)
   - –î–∞—Ç—ã: `["2027-06-30", "2027-06-30"]` (–¥–∞—Ç–∞ –æ—Ç 52 —É–¥–∞–ª–µ–Ω–∞)

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –£–¥–∞–ª–µ–Ω–∏–µ Podstawy
1. –£–¥–∞–ª—è–µ—Ç—Å—è Podstawy ID=54
2. Webhook ‚Üí Worker ‚Üí –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
3. Sprawy 18:
   - –°—Å—ã–ª–∫–∏: `["48"]`
   - –î–∞—Ç—ã: `["2027-06-30"]`

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å: `pobyt_sync.py`

**–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```python
field_podstawy_dates: str = "ufCrm38_1768738011252"
field_podstawy_data_do_kiedy: str = "ufCrm10_1763581700754"
```

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥:** `sync_all_for_contact()`
- –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö Podstawy —Å –ø–æ–ª–µ–º `ufCrm10_1763581700754`
- –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö + —Å–±–æ—Ä –¥–∞—Ç
- –®–∞–≥ 3: –ü–æ–∏—Å–∫ Sprawy —Å –ø–æ–ª—è–º–∏ `ufCrm38_1768737959` –∏ `ufCrm38_1768738011252`
- –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Sprawy (—Å—Å—ã–ª–∫–∏ + –¥–∞—Ç—ã)

### Environment Variables

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Worker:
```bash
FIELD_SPRAWY_PODSTAWY_DATES=ufCrm38_1768738011252
FIELD_PODSTAWY_DATA_DO_KIEDY=ufCrm10_1763581700754
```

---

## üìù –õ–æ–≥–∏

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```
üìò Step 1: Fetching all Podstawy pobytu for contact 194...
üìä Step 2: Filtering active items and collecting dates...
   ‚úÖ ID=48: KARTA POBYTU MOJO [DT1042_16:NEW] ‚Üí Data: 2027-06-30T03:00:00+03:00
   ‚úÖ ID=52: Podstawy pobytu #52 [DT1042_16:NEW] ‚Üí Data: 2027-06-30T03:00:00+03:00
   ‚úÖ ID=54: Podstawy pobytu #54 [DT1042_16:NEW] ‚Üí Data: 2027-06-30T03:00:00+03:00

üìà Summary: 3 total, 3 active, 0 inactive
   Active IDs: ['48', '52', '54']
   Active Dates: ['2027-06-30T03:00:00+03:00', '2027-06-30T03:00:00+03:00', '2027-06-30T03:00:00+03:00']

üìó Step 3: Finding Sprawy for contact 194...
   Found 1 Sprawy

üìó Step 4: Updating Sprawy with active links and dates...
   üìó Sprawy ID=18: DARAI BISHNU LAL
      Current links: ['48', '52', '54']
      Target links:  ['48', '52', '54']
      Current dates: ['2026-01-16T03:00:00+03:00', '2026-01-08T03:00:00+03:00']
      Target dates:  ['2027-06-30T03:00:00+03:00', '2027-06-30T03:00:00+03:00', '2027-06-30T03:00:00+03:00']
      ‚úì Already in sync - no action needed (links)
      ‚ûï Adding dates: ['2027-06-30T03:00:00+03:00']
      ‚ûñ Removing dates: ['2026-01-16T03:00:00+03:00', '2026-01-08T03:00:00+03:00']

‚úÖ FULL SYNC COMPLETED
   Contact: 194
   Podstawy: 3/3 active
   Sprawy updated: 1
```

---

## ‚úÖ Deployment

**Worker Function:** `b24-spa-1106-sync-worker`  
**Revision:** `00008-cit`  
**Deployed:** 2026-01-18 14:43:08 UTC  
**Status:** ‚úÖ Active

**Environment Variables:**
```
FIELD_SPRAWY_PODSTAWY_DATES=ufCrm38_1768738011252
FIELD_PODSTAWY_DATA_DO_KIEDY=ufCrm10_1763581700754
```

**Important Changes:**
- –ú–µ—Ç–æ–¥ `sync_podstawy_to_sprawy()` —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç `sync_all_for_contact()`
- –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞—Ç –ø—Ä–∏ –ª—é–±–æ–º —Å–æ–±—ã—Ç–∏–∏ –æ—Ç Podstawy
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ –¥–∞—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `sorted()` –≤–º–µ—Å—Ç–æ `set()`)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç

```python
import sys
sys.path.insert(0, 'google-cloud/b24-spa-1106-sync/b24-spa-1106-sync-worker')
from services.bitrix_api import BitrixAPI
from services.pobyt_sync import PodstawyPobytSyncService

bitrix = BitrixAPI(
    domain='mojo.bitrix24.pl',
    project_id='mojo-478621',
    access_token_secret='b24-access-token'
)

podstawy_sync = PodstawyPobytSyncService(
    bitrix=bitrix,
    spa_sprawy=1106,
    spa_podstawy=1042,
    field_podstawy_link='ufCrm38_1768737959',
    field_podstawy_dates='ufCrm38_1768738011252',
    field_podstawy_data_do_kiedy='ufCrm10_1763581700754'
)

# –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ 194
result = podstawy_sync.sync_all_for_contact(194)
print(f"Updated: {result['podstawy_active']} active Podstawy")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```python
sprawy = bitrix.get_item(1106, 18)
dates = sprawy.get('ufCrm38_1768738011252', [])
print(f"Dates in Sprawy: {dates}")
# Output: ['2027-06-30T03:00:00+03:00', '2027-06-30T03:00:00+03:00', '2027-06-30T03:00:00+03:00']
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [SYNC_CONFIGURATION.md](./SYNC_CONFIGURATION.md) - –û–±—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- [pobyt_sync.py](./b24-spa-1106-sync-worker/services/pobyt_sync.py) - –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å–µ—Ä–≤–∏—Å–∞
- [main.py](./b24-spa-1106-sync-worker/main.py) - Worker entry point

---

## ‚úÖ –°—Ç–∞—Ç—É—Å

- ‚úÖ –°–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ Worker –∑–∞–¥–µ–ø–ª–æ–µ–Ω —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚ö™ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhooks –≤ Bitrix24 –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
